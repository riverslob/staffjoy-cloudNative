#!groovy

pipeline {
    // agent {
    //     node {
    //         label 'node02'
    //     }
    // }

    agent any

    parameters {
        choice(
                name: 'Env',
                choices: ['dev'],
                description: 'The environment to be deployed'
        )
        choice(
                name: 'Branch',
                choices: ['test-ci-cd','master'],
                description: 'The branch to be deployed'
        )

    }

    environment {
        IMAGE_TAG="${env.BUILD_ID}"
        SERVICE_NAME="account-svc"
        DOCKERHUB_CREDENTIALS=credentials('40759b21-2fb6-4660-aead-57af75ea6e85')
        BRANCH="${params.Branch}"
        DEPLOY_ENV="${params.Env}"
    }

    stages {

        stage('checkout') {
            // 1. add git config in jenkins;
            // 2. when build in new node, should add ssh key in github;
            steps {
                echo "********* checkout start Branch: $BRANCH, Env: $DEPLOY_ENV ********"
                echo pwd()
                git branch:"$BRANCH",credentialsId:'954a8608-a1a9-4986-b19f-8a8669912212',url:'git@github.com:riverslob/staffjoy-cloudNative.git'
                echo '********* checkout end ********'
            }
        }
        
        stage('build jar') {
            steps {
                echo '********* buildJar start ********'
                sh 'mvn compile -pl :account-svc -am'
                echo '********* buildJar start ********'
            }
        }

        stage('build image') {
            steps {
                dir('account-svc') {
                    echo '********* buildImage start ********'
                    echo pwd()
                    sh 'docker build -t yanzxu/$SERVICE_NAME:$IMAGE_TAG .'
                    echo '********* buildImage end ********'
                }
            }
        }

        stage('push image') {
            steps {
                echo '********* pushImage start ********'
                sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
                echo '********* login dockerhub successfully ********'
                sh 'docker push yanzxu/$SERVICE_NAME:$IMAGE_TAG'
                echo '********* push image successfully ********'
            }
        }

        stage('deploy') {
            steps {
                dir('account-svc/deployment/k8s') {
                    echo '********* deploy start ********'
                    sh './update-deploy-image.sh $IMAGE_TAG'
                    echo '********* deploy end ********'

                }
            }
        }
    }
}
